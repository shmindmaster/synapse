# ü§ñ Agent Guidance: synapse

> **WARNING:** This repository is deployed via **DigitalOcean App Platform**.
> **DO NOT** attempt to use `kubectl`, `helm`, or `docker push`.
> **DO NOT** edit ingress or certificate files manually.

## 1. System Architecture

This is a Monorepo following the **v10.0 PaaS Standard**:

- **Frontend:** Next.js (Standalone Mode) ‚Üí Deployed as Service `web`
- **Backend:** FastAPI (Python 3.11) ‚Üí Deployed as Service `backend`
- **Database:** Shared Postgres Cluster (Logical DB: `synapse`)
- **Storage:** DigitalOcean Spaces (Prefix: `synapse/`)

## 2. Infrastructure Rules

1. **Deployment:** Happens automatically on push to `main`.
2. **Configuration:** All secrets are injected via App Platform.
   - *Local:* Use `.env` (generated by `generate-env.py`).
   - *Production:* Use `scripts/sync-app-secrets.sh`.
3. **Logs:** To view logs, run: `doctl apps logs $(doctl apps list --format ID --no-header | grep synapse)`.

## 3. Development Workflow

- **Start Local:** `pnpm dev` (Frontend) or `python src/main.py` (Backend).
- **Update Dependencies:** Wait for Renovate bot PRs or run `pnpm update`.
- **Database:** Run `scripts/migrate.sh` locally to update schema.

## 4. Key Paths

- **App Spec:** `./app.yaml` (Source of Truth for Infra)
- **Frontend Source:** `./apps/web`
- **Backend Source:** `./apps/backend`
- **Migrations:** `./apps/backend/prisma` or `./apps/backend/alembic`

## 5. Platform Standards (v10.0 - App Platform Edition)

### Architecture Identity

- **App Slug:** `synapse`
- **Database:** DO Managed Postgres (DB Name: `synapse`)
- **Storage:** DO Spaces (`sh-storage` bucket, prefix: `synapse/`)
- **App Platform:** DigitalOcean App Platform (PaaS)
- **Frontend URL:** `https://synapse.shtrial.com`
- **API URL:** `https://api-synapse.shtrial.com`
- **‚õî NO KUBERNETES.** Use App Platform only.
- **‚õî NO SUPABASE.** Use `DATABASE_URL` only.

### Storage Isolation (S3-Compatible)

**‚ö†Ô∏è CRITICAL:** Always use `OBJECT_STORAGE_PREFIX` to avoid cross-app contamination.

```python
import boto3
import os

s3 = boto3.client(
    's3',
    endpoint_url=os.getenv("AWS_ENDPOINT_URL"),
    aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),
    aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY")
)

# MUST use app prefix
key = f"{os.getenv('OBJECT_STORAGE_PREFIX')}myfile.pdf"  # synapse/myfile.pdf
s3.upload_file("/tmp/myfile.pdf", os.getenv("AWS_BUCKET_NAME"), key)
```

### Model Preferences (Use Variables)

| Use Case | Env Variable | Value | Provider |
|----------|--------------|-------|----------|
| **Reasoning** | `MODEL_CHAT` | `openai-gpt-oss-120b` | DO Gateway |
| **Fast Tasks** | `MODEL_FAST` | `openai-gpt-oss-20b` | DO Gateway |
| **Embeddings** | `MODEL_EMBEDDING` | `Alibaba-NLP/gte-large-en-v1.5` | DO Gateway |
| **Image Gen** | `MODEL_IMAGE` | `fal-ai/fast-sdxl` | DO Gateway |
| **TTS** | `MODEL_TTS` | `fal-ai/elevenlabs/tts/multilingual-v2` | DO Gateway |

**Example:**
```typescript
const response = await openai.chat.completions.create({
  model: process.env.MODEL_CHAT,  // ‚úÖ CORRECT
  // model: "gpt-4o",              // ‚ùå WRONG - Hardcoded
  messages: [...]
});
```

### Internal Service Communication

**Within App Platform App:**
- Frontend ‚Üí Backend: Use `http://backend:8000` (internal DNS)
- Backend ‚Üí Backend: Use `http://backend:8000` (same service)

**External (from browser):**
- Frontend ‚Üí Backend: Use `process.env.NEXT_PUBLIC_API_URL` (public URL)

**‚ö†Ô∏è CRITICAL:** 
- Never use `localhost` in App Platform (won't work)
- Never use K8s DNS patterns (`synapse-backend.synapse.svc.cluster.local`)
- Always use App Platform internal DNS (`backend:8000`) for server-to-server

## 6. Security and Agent Rules

### When Adding Features

1. **File Upload:** MUST use `OBJECT_STORAGE_PREFIX`
2. **Models:** MUST use env variables (`MODEL_CHAT`, `MODEL_FAST`, etc.)
3. **Internal Calls:** MUST use App Platform DNS (`http://backend:8000`)

### Security

- **Never** log API keys or secrets
- **Never** hardcode model names
- **Always** validate file paths include app prefix
- **Always** use `DATABASE_URL` (not Supabase)
- **Never** commit `.env` files
- **Never** commit `app.yaml` with secrets (use env vars)

## 7. Deployment

### Automatic Deployment

App Platform automatically deploys on push to `main` branch:

```bash
git add .
git commit -m "feat: new feature"
git push origin main
# App Platform automatically builds and deploys
```

### Viewing Logs

```bash
# All components
doctl apps logs <app-id> --follow

# Specific component
doctl apps logs <app-id> --component backend --follow
```

---

**Last Updated:** 2025-12-18
**Standard Version:** v10.0 (App Platform Edition)
**Deployment:** ‚úÖ App Platform (Automatic)
