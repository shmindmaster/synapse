# ü§ñ Agent Guidance: synapse

> **WARNING:** This repository is deployed via **DigitalOcean App Platform**.
> **DO NOT** edit ingress or certificate files manually.

## 1. System Architecture

This is a Monorepo following the **v10.0 PaaS Standard**:

- **Frontend:** Next.js/Vite/Expo ‚Üí Deployed as Service `frontend`
- **Backend:** FastAPI (Python 3.12) ‚Üí Deployed as Service `backend`
- **Database:** Shared Postgres Cluster (Logical DB: `synapse`)
- **Storage:** DigitalOcean Spaces (Prefix: `synapse/`)

## 2. Infrastructure Rules

1. **Deployment:** Happens automatically on push to `main`.
2. **Configuration:** All secrets are injected via App Platform.
   - *Local:* Use `.env` (generated by `generate-env.py`).
   - *Production:* Use `scripts/sync-app-secrets.sh`.
3. **Logs:** To view logs, run: `doctl apps logs $(doctl apps list --format ID --no-header | grep synapse)`.

## 3. Development Workflow

- **Start Local:** `pnpm dev` (Frontend) or `python src/main.py` (Backend).
- **Update Dependencies:** Wait for Renovate bot PRs or run `pnpm update`.
- **Database:** Run `scripts/migrate.sh` locally to update schema.

## 4. Key Paths

- **App Spec:** `./app.yaml` (Source of Truth for Infra)
- **Frontend Source:** `./apps/frontend`
- **Backend Source:** `./apps/backend`
- **Migrations:** `./apps/backend/prisma` or `./apps/backend/alembic`

## 5. Platform Standards (v10.0 - App Platform Edition)

### Architecture Identity

- **App Slug:** `synapse`
- **Database:** DO Managed Postgres (DB Name: `synapse`)
- **Storage:** DO Spaces (`sh-storage` bucket, prefix: `synapse/`)
- **App Platform:** DigitalOcean App Platform (PaaS)
- **Frontend URL:** `https://synapse.shtrial.com`
- **API URL:** `https://api-synapse.shtrial.com`
- **‚õî NO SUPABASE.** Use `DATABASE_URL` only.

### Storage Isolation (S3-Compatible)

**‚ö†Ô∏è CRITICAL:** Always use `OBJECT_STORAGE_PREFIX` to avoid cross-app contamination.

```python
import boto3
import os

s3 = boto3.client(
    's3',
    endpoint_url=os.getenv("AWS_ENDPOINT_URL"),
    aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),
    aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY")
)

# MUST use app prefix
key = f"{os.getenv('OBJECT_STORAGE_PREFIX')}myfile.pdf"  # synapse/myfile.pdf
s3.upload_file("/tmp/myfile.pdf", os.getenv("AWS_BUCKET_NAME"), key)
```

### Model Preferences (Use Variables)

| Use Case | Env Variable | Value | Provider |
|----------|--------------|-------|----------|
| **Reasoning** | `MODEL_CHAT` | `openai-gpt-oss-120b` | DO Gateway |
| **Fast Tasks** | `MODEL_FAST` | `openai-gpt-oss-20b` | DO Gateway |
| **Embeddings** | `MODEL_EMBEDDING` | `Alibaba-NLP/gte-large-en-v1.5` | DO Gateway |
| **Image Gen** | `MODEL_IMAGE` | `fal-ai/fast-sdxl` | DO Gateway |
| **TTS** | `MODEL_TTS` | `fal-ai/elevenlabs/tts/multilingual-v2` | DO Gateway |

**Example:**
```typescript
const response = await openai.chat.completions.create({
  model: process.env.MODEL_CHAT,  // ‚úÖ CORRECT
  // model: "gpt-4o",              // ‚ùå WRONG - Hardcoded
  messages: [...]
});
```

### Internal Service Communication

**Within App Platform App:**
- Frontend ‚Üí Backend: Use `http://backend:8000` (internal DNS)
- Backend ‚Üí Backend: Use `http://backend:8000` (same service)

**External (from browser):**
- Frontend ‚Üí Backend: Use `process.env.NEXT_PUBLIC_API_URL` (public URL)

**‚ö†Ô∏è CRITICAL:** 
- Never use `localhost` in App Platform (won't work)
- Always use App Platform internal DNS (`backend:8000`) for server-to-server

## 6. Critical Do's and Don'ts

### Shared Services

**DO:**
- ‚úÖ Use `DATABASE_URL` from environment (shared Postgres cluster `sh-shared-postgres`)
- ‚úÖ Use `OBJECT_STORAGE_PREFIX` for ALL file uploads (prevents cross-app contamination)
- ‚úÖ Use `AWS_BUCKET_NAME` and `AWS_ENDPOINT_URL` from environment
- ‚úÖ Use logical database `{APP_SLUG}` in shared Postgres cluster

**DON'T:**
- ‚ùå Create app-specific databases or storage buckets
- ‚ùå Hardcode database connection strings
- ‚ùå Upload files without `OBJECT_STORAGE_PREFIX` (e.g., `myfile.pdf` instead of `{APP_SLUG}/myfile.pdf`)
- ‚ùå Use Supabase or other external databases

### Naming Standards

**DO:**
- ‚úÖ Use `{APP_SLUG}` consistently (lowercase, DNS-safe, matches repo name)
- ‚úÖ Use `api-{APP_SLUG}.shtrial.com` (hyphen, NOT dot)
- ‚úÖ Use generic service names: `frontend`, `backend`, `worker` (App Platform scopes them)
- ‚úÖ Use `{APP_SLUG}-frontend` and `{APP_SLUG}-backend` for Sentry projects

**DON'T:**
- ‚ùå Use `api.{APP_SLUG}` (dot notation - won't work)
- ‚ùå Use app-specific service names like `{APP_SLUG}-backend` in app.yaml
- ‚ùå Mix naming conventions (e.g., `lawli-api` vs `api-lawli`)

### Technical Stack

**DO:**
- ‚úÖ Use environment variables for AI models (`MODEL_CHAT`, `MODEL_FAST`, `MODEL_EMBEDDING`)
- ‚úÖ Use Python 3.12 for backends (not 3.11 or older)
- ‚úÖ Use Node 20 for frontends
- ‚úÖ Use context-aware Dockerfiles (build from repo root, not subdirectories)
- ‚úÖ Set `ENV PYTHONPATH=/app` in backend Dockerfile
- ‚úÖ Use `COPY apps/backend/requirements.txt .` (root context) in Dockerfile

**DON'T:**
- ‚ùå Hardcode model names (e.g., `"gpt-4o"` instead of `process.env.MODEL_CHAT`)
- ‚ùå Hardcode API endpoints (use `NEXT_PUBLIC_API_URL` or `VITE_API_URL`)
- ‚ùå Use Python 3.11 or older
- ‚ùå Build Dockerfiles from subdirectories (`cd apps/backend && docker build .`)
- ‚ùå Forget to set `PYTHONPATH` (causes `ModuleNotFoundError`)

### Networking

**DO:**
- ‚úÖ Use `ingress.rules` with authority-based routing in `app.yaml`
- ‚úÖ Configure CORS in `app.yaml` (not in application code)
- ‚úÖ Use internal DNS (`http://backend:8000`) for service-to-service communication
- ‚úÖ Use `NEXT_PUBLIC_API_URL` or `VITE_API_URL` for frontend-to-backend calls from browser

**DON'T:**
- ‚ùå Use path-based routing alone (must use subdomains: `api-{APP_SLUG}.shtrial.com`)
- ‚ùå Configure CORS in application code (use `app.yaml` ingress rules)
- ‚ùå Use `localhost` in App Platform (won't work - use internal DNS)

### Deployment

**DO:**
- ‚úÖ Push to `main` branch for automatic deployment (App Platform watches GitHub)
- ‚úÖ Use `bash scripts/bootstrap-app.sh` for first-time app creation
- ‚úÖ Use `bash scripts/setup-dns.sh` after deployment (creates CNAME records)
- ‚úÖ Use `bash scripts/deploy.sh` to update app configuration from `app.yaml`
- ‚úÖ Let App Platform handle SSL certificates automatically

**DON'T:**
- ‚ùå Manually create DNS A-records (use CNAME via `setup-dns.sh`)
- ‚ùå Deploy via CI/CD scripts (App Platform watches GitHub directly)
- ‚ùå Manually manage SSL certificates (App Platform handles this)

## 7. Security and Agent Rules

### When Adding Features

1. **File Upload:** MUST use `OBJECT_STORAGE_PREFIX`
2. **Models:** MUST use env variables (`MODEL_CHAT`, `MODEL_FAST`, etc.)
3. **Internal Calls:** MUST use App Platform DNS (`http://backend:8000`)

### Security

- **Never** log API keys or secrets
- **Never** hardcode model names
- **Always** validate file paths include app prefix
- **Always** use `DATABASE_URL` (not Supabase)
- **Never** commit `.env` files
- **Never** commit `app.yaml` with secrets (use env vars)

## 8. Deployment

### First-Time Setup

**1. Create App Platform App (one-time):**
```bash
bash scripts/bootstrap-app.sh
```

**2. Setup DNS Records (after app is deployed):**
```bash
# Wait for app to finish deploying, then:
bash scripts/setup-dns.sh
```

This creates CNAME records in `shtrial.com` zone:
- `synapse.shtrial.com` ‚Üí App Platform default domain
- `api-synapse.shtrial.com` ‚Üí App Platform default domain

**Note:** DNS setup requires the app to be deployed first to get the default `.ondigitalocean.app` domain.

### Automatic Deployment

App Platform automatically deploys on push to `main` branch:

```bash
git add .
git commit -m "feat: new feature"
git push origin main
# App Platform automatically builds and deploys
```

### Manual Deployment

**Update app configuration:**
```bash
# After modifying app.yaml
bash scripts/deploy.sh
```

**Sync secrets:**
```bash
bash scripts/sync-secrets.sh
```

### Viewing Logs

```bash
# Get app ID
APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep synapse | awk '{print $1}')

# All components
doctl apps logs $APP_ID --follow

# Specific component
doctl apps logs $APP_ID --component backend --follow
```

### Available Scripts

Each repository has self-contained deployment scripts:

- **`scripts/bootstrap-app.sh`** - One-time app creation (run once)
- **`scripts/setup-dns.sh`** - Setup DNS records in shtrial.com zone (run after deployment)
- **`scripts/deploy.sh`** - Update app configuration from app.yaml
- **`scripts/sync-secrets.sh`** - Instructions for syncing environment variables
- **`scripts/migrate.sh`** - Run database migrations (called automatically by App Platform)

### Script Idempotency

All deployment scripts are **idempotent** - safe to run multiple times without errors:

- **`bootstrap-app.sh`** - Checks if app exists, updates if found, creates if not. Safe to re-run.
- **`deploy.sh`** - Updates existing app configuration. Requires app to exist (run bootstrap first).
- **`setup-dns.sh`** - Updates existing DNS records or creates new ones. Safe to re-run.
- **`migrate.sh`** - Uses `IF NOT EXISTS` patterns, safe to re-run migrations.
- **`sync-secrets.sh`** - Read-only instructions, inherently idempotent.

**Why idempotency matters:**
- Safe to re-run after template updates
- Safe to re-run after partial failures or network errors
- Safe for multiple developers working on the same repo
- Safe for CI/CD pipelines that may run scripts multiple times
- Enables recovery from manual changes or rollbacks

---

**Last Updated:** 2025-12-18
**Standard Version:** v10.0 (App Platform Edition)
**Deployment:** ‚úÖ App Platform (Automatic)
