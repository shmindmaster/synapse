# Standardization Specification v10.0 (App Platform Edition)

**For:** This Repository
**Platform:** SHTrial Platform (DigitalOcean App Platform)

## Overview

This document defines the complete standardization specification that **this repository** must follow. All SHTrial Platform repositories follow the same standards for consistency, but this specification applies to **this repository**.

## Repository Context

This specification applies to **this repository**. Your `APP_SLUG` is defined in `.env` and should match the repository name. All SHTrial Platform repositories follow the same standards for consistency, ensuring a unified development experience across the platform.

---

## 1. Canonical Naming Specification

### 1.1 Application Identity

**APP_SLUG Rules:**
- Must be DNS-safe: lowercase, numbers, hyphens only
- Must match App Platform naming rules
- Must be consistent across all resources

**Canonical Allowlist (SHTrial Platform apps):**
```
apexcoachai, aura, billigent, campgen, careaxis, careiq,
comminsightsai, financeos, flashmaster, homeiq, jurisai,
lawli, magiccommerce, omniforge, petdnaplus,
prismiq, quantcoach, serenemind, synapse, ummaconnect,
voxops, warrantygains
```

**Static Apps (4 apps - App Platform, no DB/AI):**
```
mahumtech, saroshhussain, shtrial, tgiagency
```

### 1.2 DNS Naming

- **Frontend:** `{APP_SLUG}.shtrial.com`
- **API:** `api-{APP_SLUG}.shtrial.com` (hyphen, NOT dot)
- **Platform URL:** `{APP_SLUG}.ondigitalocean.app` (Auto-generated by DO)

### 1.3 App Platform Component Naming

In App Platform, component names are scoped to the app, so we use generic functional names:

- **App Name:** `{APP_SLUG}` (e.g., `lawli`)
- **Frontend Service:** `frontend` (standard DO convention)
- **Backend Service:** `backend` (simple, descriptive)
- **Worker Service:** `worker` (optional, for background tasks)
- **Migration Job:** `migrate` (post-deploy job)

**Why Generic Names?**
- App Platform scopes names to the app, so no collision risk
- Matches DigitalOcean conventions
- Simpler internal DNS: `http://backend:8000` instead of `http://lawli-backend.lawli.svc.cluster.local`

### 1.4 GitHub Repository Naming

- **Repo:** `sh-pendoah/{APP_SLUG}` (must match App Slug exactly)

### 1.5 Sentry Naming

- **Projects:**
  - `{APP_SLUG}-frontend`
  - `{APP_SLUG}-backend`
  - Optional: `{APP_SLUG}-worker`

- **Releases:**
  - Use `${COMMIT_HASH}` (auto-injected by App Platform)
  - Format: `{APP_SLUG}-frontend@{COMMIT_HASH}` or `{APP_SLUG}@{COMMIT_HASH}`

---

## 2. Shared Platform Resources

### 2.1 Platform-Owned (Never App-Specific)

- **App Platform:** DigitalOcean App Platform (PaaS, managed)
- **Postgres Cluster:** `sh-shared-postgres` (Postgres 16 + pgvector)
- **Spaces Bucket:** `sh-storage` (shared, prefix-per-app isolation)
- **DNS:** Managed via Cloudflare/Namecheap (CNAME records)

### 2.2 Per-App Resources

- **Database:** Logical database `{APP_SLUG}` in shared Postgres
- **Storage Prefix:** `{APP_SLUG}/` in shared bucket
- **App Platform App:** One App per repository (named `{APP_SLUG}`)
- **Vector Tables:** `embeddings` (shared table, app isolation via metadata)

---

## 3. Environment Variable Contract

### 3.1 Required for Canonical Apps

```bash
# Identity & Routing
APP_SLUG={APP_SLUG}
BASE_URL=https://{APP_SLUG}.shtrial.com
API_BASE_URL=https://api-{APP_SLUG}.shtrial.com

# Database
DATABASE_URL=postgresql://.../{APP_SLUG}?sslmode=require
VECTOR_STORE_CONNECTION_STRING=${DATABASE_URL}
LANGGRAPH_CHECKPOINT_DB=${DATABASE_URL}

# Object Storage
OBJECT_STORAGE_BUCKET=sh-storage
OBJECT_STORAGE_PREFIX={APP_SLUG}/
AWS_ENDPOINT_URL=https://nyc3.digitaloceanspaces.com

# Default GenAI (DigitalOcean)
LLM_PROVIDER=do
OPENAI_BASE_URL=https://inference.do-ai.run/v1
OPENAI_API_KEY=...
MODEL_CHAT=openai-gpt-oss-120b
MODEL_FAST=openai-gpt-oss-20b
MODEL_EMBEDDING=Alibaba-NLP/gte-large-en-v1.5

# Speech / Voice
SPEECH_STT_PROVIDER=elevenlabs
SPEECH_TTS_PROVIDER=elevenlabs
VOICE_AGENT_PROVIDER=off
ELEVENLABS_API_KEY=...
ELEVENLABS_STT_MODEL=scribe_v1
ELEVENLABS_TTS_VOICE_ID=...
ELEVENLABS_AUDIO_FORMAT=mp3

# Observability
SENTRY_DSN_FRONTEND=...
SENTRY_DSN_BACKEND=...
SENTRY_RELEASE=${COMMIT_HASH}  # Auto-injected by App Platform
SENTRY_ENVIRONMENT=production
```

### 3.2 Required for Static Apps

```bash
APP_SLUG={APP_SLUG}
BASE_URL=https://{APP_SLUG}.shtrial.com
```

### 3.3 System Variables (Auto-Injected by App Platform)

These are automatically provided by DigitalOcean App Platform:

- `APP_URL`: The default `.ondigitalocean.app` URL
- `COMMIT_HASH`: The git SHA of the deployed commit
- `APP_NAME`: The app name (matches `APP_SLUG`)

---

## 4. Code Pattern Standards

### 4.1 Speech Provider Abstraction

**REQUIRED:** Remove all Whisper references
- ❌ `WHISPER_API_URL`
- ❌ `whisper-service`
- ❌ Port `:9000` references

**REQUIRED:** Use speech provider abstraction
- ✅ `SPEECH_STT_PROVIDER` (default: `elevenlabs`)
- ✅ `SPEECH_TTS_PROVIDER` (default: `elevenlabs`)
- ✅ Provider modules: `src/server/speech/stt.ts`, `src/server/speech/tts.ts`

### 4.2 API Host Pattern

**REQUIRED:** Use hyphen, not dot
- ✅ `api-{APP_SLUG}.shtrial.com`
- ❌ `api.{APP_SLUG}.shtrial.com`

### 4.3 Storage Prefix Pattern

**REQUIRED:** Use `{APP_SLUG}/` prefix
- ✅ `OBJECT_STORAGE_PREFIX={APP_SLUG}/`
- ❌ `raw/{APP_SLUG}/` or other patterns

### 4.4 Frontend Stack

**REQUIRED:**
- Tailwind CSS 4.1.x+
- Token-based theming (CSS variables)
- No hardcoded colors (hex/rgb)
- shadcn/ui components
- Responsive design (mobile-first)

### 4.5 Design System

**REQUIRED:** `DESIGN_SYSTEM.md` per repo
- Brand adjectives
- Typography rules
- Layout model
- Motion rules
- Component rules
- Shared token names, unique token values

### 4.6 Internal Service Communication

**REQUIRED:** Use App Platform internal DNS
- ✅ `http://backend:8000` (within same App)
- ❌ `http://lawli-backend.lawli.svc.cluster.local` (old K8s pattern)
- ❌ `http://localhost:8000` (won't work in App Platform)

---

## 5. Frontend Requirements

### 5.1 Framework Standards

- **Next.js:** 16+ with App Router
- **Vite:** 7+ (if using SPA)
- **React:** 19
- **Tailwind CSS:** 4.1.x
- **shadcn/ui:** Token-first CSS-variable theming

### 5.2 Required Pages

- **Landing Page:** Public, value prop, features, CTAs to /login
- **Login Page:** Branded, accessible, validation/loading/errors

### 5.3 Auth (if missing)

- Users table + sessions
- Password hashing
- login/logout endpoints
- `/me` session endpoint
- **Node/Next:** Auth.js + Prisma
- **Python:** SQLAlchemy + Alembic

### 5.4 UX Requirements

- Token-driven Light/Dark/System theming
- WCAG AA contrast
- Tap targets ≥ 44px
- No horizontal scroll on mobile
- Accessible modals/drawers
- Full keyboard navigation
- Subtle motion + respects reduced-motion

---

## 6. App Platform Manifest Standards

### 6.1 Required File: `app.yaml`

Every repository MUST have an `app.yaml` file at the root. This is the single source of truth for App Platform configuration.

**Location:** `repo-root/app.yaml`

**Structure:**
```yaml
name: {APP_SLUG}
region: nyc
services:
  - name: web
    # ... frontend config
  - name: backend
    # ... backend config
workers: []  # Optional
jobs: []     # Optional (migrations, cron)
```

### 6.2 Required Services

- **Frontend Service:** `frontend` (if has frontend)
- **Backend Service:** `backend` (if has backend)

### 6.3 Health Checks

All services must have health check endpoints:
- **Backend:** `/health` or `/api/health`
- **Frontend:** `/` (serves HTML)

**Health Check Requirements:**
- Must respond within 30 seconds
- Must listen on `0.0.0.0`, not `127.0.0.1`
- Must not require database connection to respond (degraded mode OK)

---

## 7. Validation Rules

### 7.1 Canonical Naming Validation

- All DNS uses `{APP_SLUG}` and `api-{APP_SLUG}` (hyphen)
- All App Platform components use generic names (`web`, `backend`)
- All GitHub repos use `sh-pendoah/{APP_SLUG}` naming
- All Sentry projects use `{APP_SLUG}-{component}` naming

### 7.2 Code Pattern Validation

- No Whisper references
- No `api.{APP_SLUG}` patterns (must be `api-{APP_SLUG}`)
- No hardcoded colors (warns, doesn't auto-fix)
- Storage prefixes use `{APP_SLUG}/`
- Internal service calls use App Platform DNS (`http://backend:8000`)

### 7.3 Environment Contract Validation

- Canonical apps have all required variables
- Static apps have minimal required variables
- Variable patterns match specification (BASE_URL, API_BASE_URL, etc.)
- System variables (`COMMIT_HASH`, `APP_URL`) are not manually set

### 7.4 Frontend Stack Validation

- Tailwind 4.1.x+
- Token-based theming present
- shadcn/ui components present
- Responsive patterns

### 7.5 App Platform Manifest Validation

- `app.yaml` exists at repo root
- All services have valid `source_dir` and `dockerfile_path`
- All services have `github` configuration
- Health checks are configured
- Environment variables are properly set

---

## 8. Enforcement

### 8.1 Hard Gates

- Canonical apps MUST be in allowlist
- Non-allowlisted repos are treated as non-canonical
- Static apps skip DB/AI config
- `app.yaml` must exist for all apps

### 8.2 Soft Warnings

- Hardcoded colors (warns, doesn't block)
- Missing design system docs (warns)
- Legacy model branding (warns)
- Missing health check endpoints (warns)

---

## 9. Examples

### 9.1 Canonical App Example

**APP_SLUG:** `lawli`

- DNS: `lawli.shtrial.com`, `api-lawli.shtrial.com`
- App Platform: App named `lawli`, services `frontend` and `backend`
- Sentry: `lawli-frontend`, `lawli-backend`
- Database: `lawli` (logical DB in shared cluster)
- Storage: prefix `lawli/`
- GitHub: `sh-pendoah/lawli`

### 9.2 Static App Example

**APP_SLUG:** `mahumtech`

- DNS: `mahumtech.shtrial.com` (App Platform)
- App Platform: App named `mahumtech`, service `frontend` only
- No database
- No AI config
- Frontend standards only

---

## 10. Migration Checklist

When standardizing this repository:

- [ ] Verify APP_SLUG is in canonical allowlist (or static apps list)
- [ ] Create `app.yaml` at repo root with proper structure
- [ ] Update all DNS references to use hyphen (api-{APP_SLUG})
- [ ] Update .env with complete environment contract
- [ ] Remove Whisper references, add speech provider
- [ ] Update storage prefixes to `{APP_SLUG}/`
- [ ] Update internal service calls to use App Platform DNS (`http://backend:8000`)
- [ ] Remove all K8s artifacts (`k8s/` folder, Helm charts, etc.)
- [ ] Verify Tailwind 4.1.x, upgrade if needed
- [ ] Ensure token-based theming (no hardcoded colors)
- [ ] Create/update DESIGN_SYSTEM.md
- [ ] Verify landing + login pages exist
- [ ] Add auth if missing
- [ ] Add health check endpoints
- [ ] Run all validation scripts

---

## 11. Deployment Workflow

### 11.1 Initial Setup

1. Create `app.yaml` in repo root
2. Commit and push to GitHub
3. Run: `doctl apps create --spec app.yaml`
4. Run: `./scripts/sync-app-secrets.sh <app-slug>`
5. Add domains via DO Dashboard or CLI
6. Update DNS CNAMEs

### 11.2 Daily Development

1. Make code changes locally
2. Test locally with `docker build` and `docker run`
3. Commit and push to `main` branch
4. App Platform automatically builds and deploys

### 11.3 Database Migrations

Use App Platform Jobs:

```yaml
jobs:
- name: migrate-db
  kind: POST_DEPLOY
  source_dir: apps/backend
  dockerfile_path: Dockerfile
  run_command: ./scripts/migrate.sh
```

**Why POST_DEPLOY?** Runs in runtime environment (whitelisted for DB access), not build environment.

---

**Last Updated:** 2025-12-17
**Version:** v10.0 (App Platform Edition)
