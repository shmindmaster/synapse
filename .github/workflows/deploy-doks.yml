name: Deploy to DigitalOcean Kubernetes

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_NAME: shtrial-reg

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to DOKS
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install envsubst
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        timeout-minutes: 10

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Extract APP_SLUG from .env.shared
        id: app-slug
        run: |
          if [ -f .env.shared ]; then
            APP_SLUG=$(grep "^APP_SLUG=" .env.shared | cut -d '=' -f2 | tr -d '"' | tr -d "'")
            echo "slug=$APP_SLUG" >> $GITHUB_OUTPUT
            echo "âœ… Found APP_SLUG: $APP_SLUG"
          else
            # Fallback: derive from repo name (lowercase)
            APP_SLUG=$(echo "${{ github.repository }}" | awk -F'/' '{print $2}' | tr '[:upper:]' '[:lower:]')
            echo "slug=$APP_SLUG" >> $GITHUB_OUTPUT
            echo "âš ï¸  Using repo name as APP_SLUG: $APP_SLUG"
          fi

      - name: Build and push backend image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ steps.app-slug.outputs.slug }}-api:latest -f apps/backend/Dockerfile .
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ steps.app-slug.outputs.slug }}-api:latest

      - name: Build and push frontend image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ steps.app-slug.outputs.slug }}-web:latest -f apps/frontend/Dockerfile .
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ steps.app-slug.outputs.slug }}-web:latest

      - name: Load environment variables from .env.shared
        id: env-vars
        run: |
          if [ -f .env.shared ]; then
            set -a
            source .env.shared
            set +a
            echo "APP_SLUG=$APP_SLUG" >> $GITHUB_ENV
            echo "DO_REGISTRY_URL=$DO_REGISTRY_URL" >> $GITHUB_ENV
            echo "APP_DOMAIN_BASE=$APP_DOMAIN_BASE" >> $GITHUB_ENV
            echo "APP_STORAGE_PREFIX=$APP_STORAGE_PREFIX" >> $GITHUB_ENV
            echo "âœ… Loaded environment from .env.shared"
          else
            echo "âš ï¸  .env.shared not found, using defaults"
            echo "APP_SLUG=${{ steps.app-slug.outputs.slug }}" >> $GITHUB_ENV
            echo "DO_REGISTRY_URL=registry.digitalocean.com/shtrial-reg" >> $GITHUB_ENV
            echo "APP_DOMAIN_BASE=shtrial.com" >> $GITHUB_ENV
            echo "APP_STORAGE_PREFIX=${{ steps.app-slug.outputs.slug }}" >> $GITHUB_ENV
          fi

      - name: Generate Kubernetes manifests
        run: |
          mkdir -p k8s/generated
          export APP_SLUG="${{ env.APP_SLUG }}" \
                 DO_REGISTRY_URL="${{ env.DO_REGISTRY_URL }}" \
                 APP_DOMAIN_BASE="${{ env.APP_DOMAIN_BASE }}" \
                 DATABASE_URL="${{ secrets.DO_DATABASE_URL_PRIVATE }}" \
                 DO_SPACES_KEY="${{ secrets.DO_SPACES_KEY }}" \
                 DO_SPACES_SECRET="${{ secrets.DO_SPACES_SECRET }}" \
                 DO_SPACES_BUCKET="sh-storage" \
                 DO_SPACES_ENDPOINT="https://nyc3.digitaloceanspaces.com" \
                 DO_SPACES_REGION="nyc3" \
                 NEXT_PUBLIC_CDN_BASE_URL="https://sh-storage.nyc3.cdn.digitaloceanspaces.com/${{ env.APP_STORAGE_PREFIX }}" \
                 DIGITALOCEAN_MODEL_KEY="${{ secrets.DIGITALOCEAN_MODEL_KEY }}" \
                 DIGITALOCEAN_INFERENCE_ENDPOINT="https://inference.do-ai.run/v1" \
                 AI_GPU_GATEWAY_URL="http://ai-gpu-gateway.ai-gpu.svc.cluster.local:80" \
                 AI_MODEL="llama-3.1-70b-instruct"
          for file in k8s/*.yaml; do
            [ -e "$file" ] || continue
            filename=$(basename "$file")
            envsubst < "$file" > "k8s/generated/$filename"
          done

      - name: Authenticate to Kubernetes cluster
        run: |
          doctl kubernetes cluster kubeconfig save fa17ab7c-4a61-4c4d-a80a-1fc8bf26d782
          kubectl config use-context do-nyc3-sh-demo-cluster

      - name: Deploy to Kubernetes
        run: |
          kubectl create namespace ${{ env.APP_SLUG }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/generated/ -n ${{ env.APP_SLUG }}

      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.APP_SLUG }}
          kubectl get ingress -n ${{ env.APP_SLUG }}


